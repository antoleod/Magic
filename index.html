<!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LÃ©na â€” Monde Magique (One-File)</title>
<style>
:root{
  --primary:#8b7cfb; --primary2:#b39dfd; --success:#2ecc71; --danger:#ff6b6b;
  --muted:#6b7280; --bg1:#e9f0ff; --bg2:#d8e1ff; --card:#ffffff; --shadow:0 14px 30px rgba(0,0,0,.14);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto;color:#1f2430;overflow-x:hidden}
#bgParticles{position:fixed;inset:0;z-index:0}

/* Header / Footer */
.header, .footer{position:sticky;z-index:3;backdrop-filter:blur(8px)}
.header{top:0;background:rgba(255,255,255,.75);border-bottom:1px solid #e6e6f2}
.footer{bottom:0;background:rgba(255,255,255,.85);border-top:1px solid #e6e6f2}
.header .wrap,.footer .wrap{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.brand .logo{font-size:22px}
.nav{margin-left:auto;display:flex;gap:10px}
.nav .link{border:0;background:#fff;border:2px solid #e4e8ff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:800}
.footer .wrap{justify-content:space-between}
.footer .motto{font-weight:800;color:#4b5563}
.footer .icons{display:flex;gap:8px;font-size:18px}

/* Layout */
.container{position:relative;z-index:1;max-width:1100px;margin:16px auto 70px;padding:0 16px}
.screen{display:none;border-radius:24px;box-shadow:var(--shadow);padding:16px;background:rgba(255,255,255,.75)}
.screen.show{display:block}
.fadein{animation:fade .35s ease}
@keyframes fade{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
.headline{font-weight:900;font-size:22px}
.gradient{background:linear-gradient(90deg,#5e4df7,#c49dff);-webkit-background-clip:text;background-clip:text;color:transparent}

/* Cards / boutons */
.btn{font-weight:900;border:0;cursor:pointer}
.soft{background:#fff;border:2px solid #e4e8ff;border-radius:12px;padding:10px 14px}
.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border-radius:14px;padding:12px 18px;box-shadow:0 10px 24px rgba(139,124,251,.35)}
.success{background:linear-gradient(135deg,#2ecc71,#5de39a);color:#fff;border-radius:14px;padding:12px 18px;box-shadow:0 10px 24px rgba(46,204,113,.35)}
.gem{border-radius:20px;padding:18px;background:radial-gradient(circle at 30% 20%, #fff, #f7f4ff);box-shadow:0 10px 24px rgba(0,0,0,.12);position:relative;overflow:hidden;transition:transform .15s}
.gem::after{content:'';position:absolute;inset:-2px;border-radius:inherit;padding:2px;background:conic-gradient(from 0deg, #fff0, #b39dfd55, #fff0, #8b7cfb55, #fff0);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:spin 4s linear infinite}
@keyframes spin{to{transform:rotate(1turn)}}
.gem:hover{transform:translateY(-4px)}
.cardPulse{animation:pulse 1.8s ease-in-out infinite}
@keyframes pulse{0%{box-shadow:0 10px 24px rgba(0,0,0,.12)}50%{box-shadow:0 16px 40px rgba(139,124,251,.35)}100%{box-shadow:0 10px 24px rgba(0,0,0,.12)}}
.big{font-size:48px;display:block}
.gamesGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-bottom:12px}
.emoji{font-size:40px}

/* Stats bandeau */
.stats{display:flex;gap:10px;flex-wrap:wrap;font-weight:800}

/* Niveaux (dans un dialog modal) */
dialog{border:0;border-radius:20px;padding:16px;box-shadow:var(--shadow);max-width:720px;width:clamp(300px,90vw,720px)}
.levels{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
.levelbtn{padding:16px;border-radius:14px;border:2px solid #dde3ff;background:#fff;cursor:pointer;font-weight:900;transition:transform .12s, box-shadow .2s}
.levelbtn:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.12)}
.levelbtn.done{background:#e9fbef;border-color:#b5f0c9;color:#0f5132;box-shadow:inset 0 0 0 2px #34c759}

/* Zone de jeu */
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.badge{background:#eef3ff;border:1px solid #d9e2ff;border-radius:999px;padding:6px 12px;font-weight:800}
.row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.images{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.imgcard{background:#f8fbff;border:3px solid #dfe7ff;border-radius:18px;padding:14px;min-height:180px;text-align:center;position:relative;overflow:hidden}
.imgcard span{font-size:64px}
.float{animation:levitate 2.5s ease-in-out infinite}
@keyframes levitate{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.pill{border-radius:999px;padding:14px 18px;background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.12);transition:transform .08s, box-shadow .15s}
.pill:active{transform:translateY(2px)}
.neon{position:relative}
.neon::before{content:'';position:absolute;inset:-2px;border-radius:inherit;background:linear-gradient(90deg,#9b8bff,#8bf0ff,#ff8bd9);filter:blur(8px);opacity:.35;z-index:-1}
.choice{font-size:20px;margin:6px 0}
.choice.correct{outline:4px solid var(--success)}
.choice.wrong{outline:4px solid var(--danger);animation:shake .35s ease}
@keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-6px)}40%,60%{transform:translateX(6px)}}
.hint{margin-top:6px;font-size:14px;color:var(--muted)}
.footerline{margin-top:8px;display:flex;align-items:center;justify-content:space-between}
.goalbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.potion{height:16px;background:#e7ebff;border-radius:999px;overflow:hidden;flex:1;position:relative}
.potion i{display:block;height:100%;width:0;background:linear-gradient(90deg,#6aa9ff,#8bc34a);box-shadow:0 0 18px 6px rgba(138,204,101,.25) inset}
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px}
.cell{background:#fff;border:2px solid #dfe7ff;border-radius:14px;padding:10px;text-align:center;font-weight:800;cursor:pointer;min-height:54px;display:flex;align-items:center;justify-content:center;transition:transform .08s}
.cell:active{transform:scale(.98)}
.cell.good{outline:3px solid var(--success)}
.cell.bad{outline:3px solid var(--danger)}
.surprise{display:flex;flex-direction:column;gap:10px;align-items:center}
.surGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.surOpt{font-size:48px;border-radius:16px;border:2px solid #e4e8ff;background:#fff;padding:8px 12px;cursor:pointer}

/* Histoires */
.storyList{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.storyBox{margin-top:14px;background:#fff;border:2px solid #e4e8ff;border-radius:16px;padding:12px;display:none}
.typewriter{min-height:120px;white-space:pre-wrap}

/* Fin de niveau */
#finishDlg .stars{display:flex;gap:8px;justify-content:center;margin:8px 0}
.star{width:36px;height:36px;clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);background:#ffd166;filter:drop-shadow(0 6px 10px rgba(0,0,0,.15))}
.star.off{background:#e6e6e6}
.chest{position:relative;width:160px;height:120px;margin:10px auto}
.chest .box{position:absolute;bottom:0;left:0;right:0;height:80px;background:#d08b43;border:4px solid #9a5d20;border-bottom-left-radius:10px;border-bottom-right-radius:10px}
.chest .lid{position:absolute;top:0;left:0;right:0;height:60px;background:#c27a38;border:4px solid #9a5d20;border-top-left-radius:10px;border-top-right-radius:10px;transform-origin:left bottom}
.chest.open .lid{animation:openLid .7s ease forwards}
@keyframes openLid{to{transform:rotateX(55deg)}}
.chest .shine{position:absolute;top:34px;left:10px;right:10px;height:18px;background:radial-gradient(circle,#fff8,transparent);opacity:0}
.chest.open .shine{animation:shine .9s ease .5s forwards}
@keyframes shine{to{opacity:1}}
.confetti{position:fixed;inset:0;pointer-events:none}

/* Grilles */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin:10px 0}

@media (max-width:920px){
  .row{grid-template-columns:1fr}
  .levels{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
}
</style>
</head>
<body>
<canvas id="bgParticles"></canvas>

<!-- HEADER -->
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="logo">ğŸª„</span> <span>Monde Magique</span></div>
    <nav class="nav">
      <button class="link" data-nav="home">Accueil</button>
      <button class="link" data-nav="games">Jeux</button>
      <button class="link" data-nav="stories">Histoires</button>
    </nav>
    <div class="stats">
      <span>â­ Bons: <b id="ok">0</b></span>
      <span>âŒ Erreurs: <b id="ko">0</b></span>
      <span>ğŸ•’ Temps: <b id="time">0s</b></span>
      <span>ğŸª™ PiÃ¨ces: <b id="coins">0</b></span>
    </div>
  </div>
</header>

<main class="container">
  <!-- ACCUEIL -->
  <section id="home" class="screen show fadein">
    <h2 class="headline gradient">Choisis une catÃ©gorie</h2>
    <div class="cards">
      <button class="btn gem cardPulse" data-nav="games">
        <span class="big">ğŸ®</span><h3>Jeux</h3><p>Apprends en tâ€™amusant.</p>
      </button>
      <button class="btn gem cardPulse" data-nav="stories">
        <span class="big">ğŸ“š</span><h3>Histoires</h3><p>3â€“5 min avec quiz.</p>
      </button>
    </div>
  </section>

  <!-- JEUX -->
  <section id="games" class="screen fadein">
    <h2 class="headline gradient">Jeux</h2>
    <div class="gamesGrid">
      <button class="btn gem" data-game="attrape"><span class="emoji">ğŸ¯</span>
        <div><h3>Attrape le mot</h3><p>2 images + 2 mots</p></div>
      </button>
      <button class="btn gem" data-game="shaman"><span class="emoji">ğŸª„</span>
        <div><h3>Shaman Magic</h3><p>Choisis par genre</p></div>
      </button>
      <button class="btn gem" data-game="surprise"><span class="emoji">ğŸ</span>
        <div><h3>Jeu surprise</h3><p>DÃ©couvre la magie</p></div>
      </button>
    </div>
  </section>

  <!-- ZONE DE JEU -->
  <section id="play" class="screen fadein">
    <div class="toolbar">
      <button class="btn soft" id="backLevels">â¬…ï¸ Niveaux</button>
      <span class="badge" id="gameTitle"></span>
      <span class="badge" id="levelTitle"></span>
    </div>

    <!-- ATTRAPE -->
    <div id="mode-attrape" class="mode">
      <div class="row">
        <div class="images">
          <div class="imgcard float" id="imgA"><span>ğŸª¸</span><p>â€”</p></div>
          <div class="imgcard float" id="imgB"><span>ğŸ¸</span><p>â€”</p></div>
        </div>
        <div class="choices">
          <button class="btn pill neon choice" id="opt1">mot 1</button>
          <button class="btn pill neon choice" id="opt2">mot 2</button>
          <div class="hint" id="hintAttrape"></div>
        </div>
      </div>
      <div class="footerline">
        <span id="seriesTxt">SÃ©rie 1 / 1</span>
        <button class="btn success" id="btnFinishAttrape">Terminer le niveau âœ…</button>
      </div>
    </div>

    <!-- SHAMAN -->
    <div id="mode-shaman" class="mode">
      <div class="goalbar">
        <span id="goalText">SÃ©lectionne uniquement les mots masculins</span>
        <div class="potion"><i id="bar"></i></div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="footerline">
        <button class="btn success" id="btnFinishShaman">Terminer le niveau âœ…</button>
      </div>
      <div class="hint" id="hintShaman"></div>
    </div>

    <!-- SURPRISE -->
    <div id="mode-surprise" class="mode">
      <h3 class="headline gradient">ğŸ Devine par le son</h3>
      <p>Ã‰coute lâ€™indice puis choisis.</p>
      <div class="surprise">
        <button class="btn soft" id="btnPlayClue">ğŸ”Š Jouer lâ€™indice</button>
        <div class="surGrid">
          <button class="surOpt" id="sur1">ğŸœ</button>
          <button class="surOpt" id="sur2">ğŸ¸</button>
        </div>
        <div class="hint" id="hintSur"></div>
        <div class="footerline">
          <button class="btn success" id="btnFinishSur">Terminer le niveau âœ…</button>
        </div>
      </div>
    </div>
  </section>

  <!-- HISTOIRES -->
  <section id="stories" class="screen fadein">
    <h2 class="headline gradient">Histoires magiques</h2>
    <div class="storyList" id="storyList"></div>
    <article class="storyBox" id="storyBox">
      <h3 id="storyTitle">â€”</h3>
      <div id="storyText" class="typewriter"></div>
      <div class="cards" id="quizBox" style="display:none"></div>
      <div class="cards">
        <button class="btn soft" id="btnStoryPlay">ğŸ”Š Ã‰couter</button>
        <button class="btn primary" id="btnStoryNew">ğŸ”„ Nouvelle version</button>
      </div>
    </article>
  </section>
</main>

<!-- FOOTER -->
<footer class="footer">
  <div class="wrap">
    <div class="motto">Continue dâ€™apprendre, petit magicien ! ğŸª„</div>
    <div class="icons">â­ â¤ï¸ ğŸ“š ğŸ¯ ğŸ§ </div>
  </div>
</footer>

<!-- Dialog Niveaux (sous-menu par jeu) -->
<dialog id="dlgLevels">
  <h3 id="dlgTitle">Niveaux</h3>
  <div class="levels" id="dlgLevelsGrid"></div>
  <div class="cards" style="margin-top:10px;justify-content:flex-end">
    <button class="btn soft" id="dlgClose">Fermer</button>
  </div>
</dialog>

<!-- Dialog Fin de niveau -->
<dialog id="finishDlg">
  <h3 class="headline gradient">ğŸ‰ Niveau terminÃ© !</h3>
  <div class="stars" id="stars"></div>
  <div class="chest" id="chest"><div class="lid"></div><div class="box"></div><div class="shine"></div></div>
  <p id="finishMsg">Tu gagnes des piÃ¨ces !</p>
  <div class="cards" style="justify-content:flex-end">
    <button class="btn primary" id="btnGoLevels">Retour aux niveaux</button>
  </div>
</dialog>

<canvas id="confetti" class="confetti"></canvas>

<script>
/* ====== DonnÃ©es ====== */
const WORDS=[
 {w:"grenouille",g:"f",e:"ğŸ¸",rule:"-ouille â†’ fÃ©minin"},
 {w:"corail",g:"m",e:"ğŸª¸",rule:"-ail â†’ masculin"},
 {w:"Ã©ventail",g:"m",e:"ğŸª­",rule:"-ail â†’ masculin"},
 {w:"muraille",g:"f",e:"ğŸ§±",rule:"-aille â†’ fÃ©minin"},
 {w:"paille",g:"f",e:"ğŸ¥¤",rule:"-aille â†’ fÃ©minin"},
 {w:"nouille",g:"f",e:"ğŸœ",rule:"-ouille â†’ fÃ©minin"},
 {w:"portail",g:"m",e:"ğŸšª",rule:"-ail â†’ masculin"},
 {w:"citrouille",g:"f",e:"ğŸƒ",rule:"-ouille â†’ fÃ©minin"},
 {w:"bataille",g:"f",e:"âš”ï¸",rule:"-aille â†’ fÃ©minin"},
 {w:"ratatouille",g:"f",e:"ğŸ¥˜",rule:"-ouille â†’ fÃ©minin"},
 {w:"Ã©caille",g:"f",e:"ğŸŸ",rule:"-aille â†’ fÃ©minin"},
 {w:"Ã©pouvantail",g:"m",e:"ğŸŒ¾",rule:"-ail â†’ masculin"},
 {w:"fenouil",g:"m",e:"ğŸ¥¬",rule:"-ouil â†’ masculin (souvent)"},
 {w:"rail",g:"m",e:"ğŸ›¤ï¸",rule:"-ail â†’ masculin"},
 {w:"travail",g:"m",e:"ğŸ’¼",rule:"-ail â†’ masculin"},
 {w:"mÃ©daille",g:"f",e:"ğŸ¥‡",rule:"-aille â†’ fÃ©minin"},
];

/* ====== Ã‰tat / utilitaires ====== */
const STORE={coins:'lena.coins',progress:'lena.progress.onefile.fr'};
let coins=+(localStorage.getItem(STORE.coins)||0);
let ok=0,ko=0,timerInt=null,startedAt=Date.now();
const $=id=>document.getElementById(id);
const views={home:$('home'),games:$('games'),play:$('play'),stories:$('stories')};
const stats={ok:$('ok'),ko:$('ko'),time:$('time'),coins:$('coins')};
stats.coins.innerText=coins;

function updateStats(){ stats.ok.innerText=ok; stats.ko.innerText=ko; stats.coins.innerText=coins; }
function addCoins(n){ coins+=n; localStorage.setItem(STORE.coins,coins); updateStats(); }
function startTimer(){ if(timerInt) clearInterval(timerInt); startedAt=Date.now(); timerInt=setInterval(()=>{ stats.time.innerText=Math.floor((Date.now()-startedAt)/1000)+'s'; },250); }
function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='fr-FR'; u.rate=.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function articleOf(w){ const v=/^[aeiouyÃ¢ÃªÃ®Ã´Ã»Ã©Ã¨Ã«Ã¯Ã¼Å“]/i.test(w.w); return (w.g==='m'?(v?"lâ€™":"le"):(v?"lâ€™":"la")); }
function loadProgress(){ try{ return JSON.parse(localStorage.getItem(STORE.progress)||'{}'); }catch(_){ return {}; } }
function saveProgress(game,level){ const p=loadProgress(); p[game]=p[game]||{}; p[game][level]=true; localStorage.setItem(STORE.progress,JSON.stringify(p)); }
function show(view){ Object.values(views).forEach(v=>v.classList.remove('show')); views[view].classList.add('show'); startTimer(); }

document.querySelectorAll('[data-nav]').forEach(b=>b.addEventListener('click',()=>show(b.dataset.nav)));

/* ====== Fond de particules ====== */
const bg=document.getElementById('bgParticles'); const g=bg.getContext('2d');
function resizeBg(){ bg.width=innerWidth; bg.height=innerHeight; } addEventListener('resize',resizeBg); resizeBg();
const P=Array.from({length:90},()=>({x:Math.random()*bg.width,y:Math.random()*bg.height,vx:(Math.random()-.5)*.6,vy:(Math.random()-.5)*.6,r:1+Math.random()*2,a:.3+.5*Math.random()}));
(function loop(){ g.clearRect(0,0,bg.width,bg.height); P.forEach(p=>{ p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>bg.width)p.vx*=-1;if(p.y<0||p.y>bg.height)p.vy*=-1; g.globalAlpha=p.a; g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2); g.fillStyle='#b39dfd'; g.fill(); }); requestAnimationFrame(loop); })();

/* ====== Dialog Niveaux ====== */
const dlg=$('dlgLevels'), dlgTitle=$('dlgTitle'), dlgGrid=$('dlgLevelsGrid');
$('dlgClose').onclick=()=>dlg.close();

/* ====== Lancement depuis JEUX ====== */
let currentGame='attrape', currentLevel=1;
document.querySelectorAll('[data-game]').forEach(b=>b.addEventListener('click',()=>{
  currentGame=b.dataset.game;
  openLevels(currentGame);
}));

function openLevels(game){
  dlgTitle.innerText = (game==='attrape'?'ğŸ¯ Attrape le mot â€” Niveaux': game==='shaman'?'ğŸª„ Shaman Magic â€” Niveaux':'ğŸ Surprise â€” Niveaux');
  const prog=loadProgress(); dlgGrid.innerHTML='';
  for(let i=1;i<=5;i++){
    const btn=document.createElement('button'); btn.className='levelbtn'; btn.textContent=`Niveau ${i}`;
    if(prog[game]?.[i]) btn.classList.add('done');
    btn.onclick=()=>{ currentLevel=i; startLevel(game,i); dlg.close(); };
    dlgGrid.appendChild(btn);
  }
  dlg.showModal();
}

$('backLevels').onclick=()=>openLevels(currentGame);

/* ====== Zone de jeu ====== */
function startLevel(game, lvl){
  ok=0; ko=0; updateStats();
  $('gameTitle').innerText=(game==='attrape'?'ğŸ¯ Attrape le mot':game==='shaman'?'ğŸª„ Shaman Magic':'ğŸ Surprise');
  $('levelTitle').innerText=`Niveau ${lvl}`;
  if(game==='attrape'){ setupAttrape(); showMode('attrape'); }
  else if(game==='shaman'){ setupShaman(); showMode('shaman'); }
  else { setupSurprise(); showMode('surprise'); }
  show('play');
}
function showMode(m){ ['attrape','shaman','surprise'].forEach(x=>document.getElementById('mode-'+x).style.display=(x===m?'block':'none')); }

/* ====== Confettis ====== */
function confettiBurst(){
  const c=$('confetti'); const ctx=c.getContext('2d'); c.width=innerWidth; c.height=innerHeight;
  const parts=Array.from({length:90},()=>({x:c.width/2,y:c.height/2,vx:(Math.random()-.5)*9,vy:(Math.random()-1.2)*8,a:1,r:2+Math.random()*3}));
  (function step(){ ctx.clearRect(0,0,c.width,c.height); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=.2; p.a-=.02; ctx.globalAlpha=Math.max(p.a,0); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }); if(parts.some(p=>p.a>0)) requestAnimationFrame(step); else ctx.clearRect(0,0,c.width,c.height); })();
}

/* ====== Jeu 1 : Attrape le mot (avancÃ©e auto) ====== */
let attrWords=[], attrIdx=0, attrCurrent=null;
function poolAttr(lvl){
  const groups=[['travail','corail','paille','grenouille'],['muraille','nouille','portail','citrouille'],['bataille','ratatouille','Ã©caille','rail'],['mÃ©daille','Ã©ventail','fenouil','Ã©pouvantail'],['corail','citrouille','grenouille','mÃ©daille']];
  const names=groups[Math.max(0,Math.min(4,lvl-1))]; return WORDS.filter(w=>names.includes(w.w));
}
function setupAttrape(){ attrWords=shuffle(poolAttr(currentLevel)); attrIdx=0; $('hintAttrape').innerText=''; $('seriesTxt').innerText='SÃ©rie 1 / 1'; renderAttrape(); }
function renderAttrape(){
  const a=attrWords[attrIdx], b=pickConfuser(a); attrCurrent={correct:a,other:b};
  $('imgA').querySelector('span').innerText=a.e; $('imgA').querySelector('p').innerText=a.w;
  $('imgB').querySelector('span').innerText=b.e; $('imgB').querySelector('p').innerText=b.w;
  const opts=shuffle([a.w,b.w]); $('opt1').innerText=opts[0]; $('opt2').innerText=opts[1];
  ['opt1','opt2'].forEach(id=>$(id).classList.remove('correct','wrong'));
}
function pickConfuser(word){ const end=word.w.slice(-4); const c=WORDS.filter(w=>w.w!==word.w&&(w.w.endsWith(end)||w.w.includes(end.slice(-3)))); return (c.length?c:WORDS.filter(w=>w.g!==word.g))[Math.floor(Math.random()*(c.length?c.length:WORDS.length))]; }
$('opt1').onclick=()=>chooseAttr($('opt1')); $('opt2').onclick=()=>chooseAttr($('opt2'));
function chooseAttr(btn){
  const text=btn.innerText, isRight=text===attrCurrent.correct.w;
  if(isRight){ ok++; addCoins(1); updateStats(); btn.classList.add('correct'); confettiBurst(); $('hintAttrape').innerText=`âœ… ${articleOf(attrCurrent.correct)} ${attrCurrent.correct.w} â€” ${attrCurrent.correct.rule}`; }
  else{ ko++; updateStats(); btn.classList.add('wrong'); navigator.vibrate?.([20,40,20]); $('hintAttrape').innerText=`âŒ Ce nâ€™est pas â€œ${text}â€. Correct: ${articleOf(attrCurrent.correct)} ${attrCurrent.correct.w}. Indice: ${attrCurrent.correct.rule}`; }
  // Avance auto vers la suivante
  setTimeout(()=>{ if(attrIdx<attrWords.length-1){ attrIdx++; renderAttrape(); } else { $('hintAttrape').innerText='ğŸ‰ SÃ©rie terminÃ©e. â€œTerminer le niveauâ€.'; } }, 650);
}
$('btnFinishAttrape').onclick=()=>finishLevel();

/* ====== Jeu 2 : Shaman Magic (avancÃ©e visuelle) ====== */
let target='m';
function setupShaman(){ target=(currentLevel%2===1)?'m':'f'; $('goalText').innerText=target==='m'?'SÃ©lectionne uniquement les mots masculins':'SÃ©lectionne uniquement les mots fÃ©minins'; $('bar').style.width='0%'; $('hintShaman').innerText=''; renderBoard(); }
function renderBoard(){
  const grid=$('grid'); grid.innerHTML=''; shuffle(WORDS).slice(0,15).forEach(w=>{
    const d=document.createElement('div'); d.className='cell'; d.textContent=w.w;
    d.onclick=()=>{ const okPick=(w.g===target); if(okPick){ d.classList.add('good'); ok++; addCoins(1); updateStats(); confettiBurst(); const good=document.querySelectorAll('.cell.good').length; $('bar').style.width=Math.min(100,good*10)+'%'; $('hintShaman').innerText=`âœ… ${articleOf(w)} ${w.w} â€” ${w.rule}`; }
      else{ d.classList.add('bad'); ko++; updateStats(); $('hintShaman').innerText=`âŒ ${w.w} nâ€™est pas du bon genre.`; navigator.vibrate?.([20,40,20]); } };
    grid.appendChild(d);
  });
}
$('btnFinishShaman').onclick=()=>finishLevel();

/* ====== Jeu 3 : Surprise ====== */
function setupSurprise(){ $('hintSur').innerText=''; }
$('btnPlayClue').onclick=()=>speak('nouille');
$('sur1').onclick=()=>{ ok++; addCoins(1); updateStats(); $('hintSur').innerText='âœ… Bravo ! Câ€™Ã©tait â€œnouilleâ€.'; confettiBurst(); setTimeout(()=>$('hintSur').innerText='âœ¨ Tu peux terminer le niveau.', 700); };
$('sur2').onclick=()=>{ ko++; updateStats(); $('hintSur').innerText='âŒ Oups ! Câ€™est â€œgrenouilleâ€.'; navigator.vibrate?.([20,40,20]); };

/* ====== Fin de niveau ====== */
$('btnGoLevels').onclick=()=>{ $('finishDlg').close(); openLevels(currentGame); };
function finishLevel(){
  saveProgress(currentGame,currentLevel);
  const accuracy=ok+ko>0? ok/(ok+ko) : 1;
  const stars = accuracy>=.9?3:accuracy>=.7?2:1;
  const cont=$('stars'); cont.innerHTML=''; for(let i=0;i<3;i++){ const s=document.createElement('div'); s.className='star'+(i<stars?'':' off'); cont.appendChild(s); }
  const chest=$('chest'); chest.classList.remove('open'); setTimeout(()=>chest.classList.add('open'), 200);
  const reward=stars*5; addCoins(reward);
  $('finishMsg').innerText=`Tu gagnes +${reward} ğŸª™ (prÃ©cision ${(accuracy*100|0)}%)`;
  $('finishDlg').showModal();
}

/* ====== Histoires + Quiz ====== */
const storyWords=WORDS.map(w=>w.w);
function buildStoryList(){
  const list=$('storyList'); list.innerHTML='';
  storyWords.forEach(k=>{ const b=document.createElement('button'); b.className='soft'; b.textContent=k+'  âœ'; b.onclick=()=>openStory(k); list.appendChild(b); });
}
function typewriter(el, text, speed=18){ el.innerText=''; let i=0; (function next(){ if(i<text.length){ el.innerText+=text[i++]; setTimeout(next, speed); } })(); }
function storyFor(word){
  const wObj=WORDS.find(x=>x.w===word)||{w:word,g:'m',e:'âœ¨'}; const art=articleOf(wObj);
  return `${wObj.e} Il Ã©tait une fois ${art}${word} qui rÃªvait dâ€™aventure.
Dans la forÃªt Ã©tincelante ğŸŒ²âœ¨, ${art}${word} rencontra une grenouille courageuse ğŸ¸ et une vieille muraille ğŸ§± qui savait parler.
â€œCherche la clÃ© du rire !â€, dit la muraille. Suspenseâ€¦ puis un cÅ“ur ğŸ’– apparut dans le ciel.
Ensemble, ils ont appris que la joie partagÃ©e illumine le chemin â­.`;
}
function quizFor(word){
  // 2â€“3 Q simples
  return [
    {q:"Quel est le hÃ©ros de lâ€™histoire ?", opts:[word,"un chat"], ok:0},
    {q:"Quel indice a donnÃ© la muraille ?", opts:["Cherche la clÃ© du rire","Cours trÃ¨s vite"], ok:0},
    {q:"Quâ€™apprennent-ils Ã  la fin ?", opts:["La joie partagÃ©e","La colÃ¨re gagne toujours"], ok:0},
  ];
}
function openStory(word){
  $('storyTitle').innerText='ğŸ“– '+word;
  $('storyBox').style.display='block';
  const txt=storyFor(word);
  typewriter($('storyText'), txt, 16);
  // mini quiz
  const quiz=quizFor(word); const box=$('quizBox'); box.innerHTML=''; box.style.display='grid';
  quiz.forEach((it,i)=>{
    const card=document.createElement('div'); card.className='soft'; card.style.padding='12px';
    const q=document.createElement('div'); q.style.fontWeight='900'; q.textContent='Q'+(i+1)+'. '+it.q; card.appendChild(q);
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px';
    it.opts.forEach((o,idx)=>{
      const b=document.createElement('button'); b.className='btn soft'; b.textContent=o;
      b.onclick=()=>{
        const good=(idx===it.ok);
        if(good){ b.style.borderColor='#34c759'; b.style.background='#e9fbef'; addCoins(1); confettiBurst(); }
        else{ b.style.borderColor='#ff6b6b'; b.style.background='#ffecec'; navigator.vibrate?.([20,40,20]); }
        // dÃ©sactiver boutons de cette Q
        Array.from(row.children).forEach(ch=>ch.disabled=true);
      };
      row.appendChild(b);
    });
    card.appendChild(row); box.appendChild(card);
  });
}
$('btnStoryPlay').onclick=()=>speak($('storyText').innerText);
$('btnStoryNew').onclick=()=>{ const w=$('storyTitle').innerText.replace('ğŸ“– ',''); openStory(w); };

/* ====== Boot ====== */
function boot(){ show('home'); updateStats(); buildStoryList(); }
boot();
</script>
</body>
</html><!doctype html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>LÃ©na â€” Monde Magique (One-File)</title>
<style>
:root{
  --primary:#8b7cfb; --primary2:#b39dfd; --success:#2ecc71; --danger:#ff6b6b;
  --muted:#6b7280; --bg1:#e9f0ff; --bg2:#d8e1ff; --card:#ffffff; --shadow:0 14px 30px rgba(0,0,0,.14);
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:linear-gradient(180deg,var(--bg1),var(--bg2));font-family:system-ui,-apple-system,Segoe UI,Roboto;color:#1f2430;overflow-x:hidden}
#bgParticles{position:fixed;inset:0;z-index:0}

/* Header / Footer */
.header, .footer{position:sticky;z-index:3;backdrop-filter:blur(8px)}
.header{top:0;background:rgba(255,255,255,.75);border-bottom:1px solid #e6e6f2}
.footer{bottom:0;background:rgba(255,255,255,.85);border-top:1px solid #e6e6f2}
.header .wrap,.footer .wrap{max-width:1100px;margin:0 auto;padding:10px 16px;display:flex;align-items:center;gap:12px}
.brand{display:flex;align-items:center;gap:8px;font-weight:900}
.brand .logo{font-size:22px}
.nav{margin-left:auto;display:flex;gap:10px}
.nav .link{border:0;background:#fff;border:2px solid #e4e8ff;border-radius:12px;padding:8px 12px;cursor:pointer;font-weight:800}
.footer .wrap{justify-content:space-between}
.footer .motto{font-weight:800;color:#4b5563}
.footer .icons{display:flex;gap:8px;font-size:18px}

/* Layout */
.container{position:relative;z-index:1;max-width:1100px;margin:16px auto 70px;padding:0 16px}
.screen{display:none;border-radius:24px;box-shadow:var(--shadow);padding:16px;background:rgba(255,255,255,.75)}
.screen.show{display:block}
.fadein{animation:fade .35s ease}
@keyframes fade{from{opacity:0;transform:scale(.98)}to{opacity:1;transform:scale(1)}}
.headline{font-weight:900;font-size:22px}
.gradient{background:linear-gradient(90deg,#5e4df7,#c49dff);-webkit-background-clip:text;background-clip:text;color:transparent}

/* Cards / boutons */
.btn{font-weight:900;border:0;cursor:pointer}
.soft{background:#fff;border:2px solid #e4e8ff;border-radius:12px;padding:10px 14px}
.primary{background:linear-gradient(135deg,var(--primary),var(--primary2));color:#fff;border-radius:14px;padding:12px 18px;box-shadow:0 10px 24px rgba(139,124,251,.35)}
.success{background:linear-gradient(135deg,#2ecc71,#5de39a);color:#fff;border-radius:14px;padding:12px 18px;box-shadow:0 10px 24px rgba(46,204,113,.35)}
.gem{border-radius:20px;padding:18px;background:radial-gradient(circle at 30% 20%, #fff, #f7f4ff);box-shadow:0 10px 24px rgba(0,0,0,.12);position:relative;overflow:hidden;transition:transform .15s}
.gem::after{content:'';position:absolute;inset:-2px;border-radius:inherit;padding:2px;background:conic-gradient(from 0deg, #fff0, #b39dfd55, #fff0, #8b7cfb55, #fff0);-webkit-mask:linear-gradient(#000 0 0) content-box,linear-gradient(#000 0 0);-webkit-mask-composite:xor;mask-composite:exclude;animation:spin 4s linear infinite}
@keyframes spin{to{transform:rotate(1turn)}}
.gem:hover{transform:translateY(-4px)}
.cardPulse{animation:pulse 1.8s ease-in-out infinite}
@keyframes pulse{0%{box-shadow:0 10px 24px rgba(0,0,0,.12)}50%{box-shadow:0 16px 40px rgba(139,124,251,.35)}100%{box-shadow:0 10px 24px rgba(0,0,0,.12)}}
.big{font-size:48px;display:block}
.gamesGrid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:14px;margin-bottom:12px}
.emoji{font-size:40px}

/* Stats bandeau */
.stats{display:flex;gap:10px;flex-wrap:wrap;font-weight:800}

/* Niveaux (dans un dialog modal) */
dialog{border:0;border-radius:20px;padding:16px;box-shadow:var(--shadow);max-width:720px;width:clamp(300px,90vw,720px)}
.levels{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:10px}
.levelbtn{padding:16px;border-radius:14px;border:2px solid #dde3ff;background:#fff;cursor:pointer;font-weight:900;transition:transform .12s, box-shadow .2s}
.levelbtn:hover{transform:translateY(-2px);box-shadow:0 10px 22px rgba(0,0,0,.12)}
.levelbtn.done{background:#e9fbef;border-color:#b5f0c9;color:#0f5132;box-shadow:inset 0 0 0 2px #34c759}

/* Zone de jeu */
.toolbar{display:flex;gap:10px;align-items:center;margin-bottom:10px}
.badge{background:#eef3ff;border:1px solid #d9e2ff;border-radius:999px;padding:6px 12px;font-weight:800}
.row{display:grid;grid-template-columns:1fr 1fr;gap:18px}
.images{display:grid;grid-template-columns:1fr 1fr;gap:14px}
.imgcard{background:#f8fbff;border:3px solid #dfe7ff;border-radius:18px;padding:14px;min-height:180px;text-align:center;position:relative;overflow:hidden}
.imgcard span{font-size:64px}
.float{animation:levitate 2.5s ease-in-out infinite}
@keyframes levitate{0%{transform:translateY(0)}50%{transform:translateY(-6px)}100%{transform:translateY(0)}}
.pill{border-radius:999px;padding:14px 18px;background:#fff;box-shadow:0 10px 20px rgba(0,0,0,.12);transition:transform .08s, box-shadow .15s}
.pill:active{transform:translateY(2px)}
.neon{position:relative}
.neon::before{content:'';position:absolute;inset:-2px;border-radius:inherit;background:linear-gradient(90deg,#9b8bff,#8bf0ff,#ff8bd9);filter:blur(8px);opacity:.35;z-index:-1}
.choice{font-size:20px;margin:6px 0}
.choice.correct{outline:4px solid var(--success)}
.choice.wrong{outline:4px solid var(--danger);animation:shake .35s ease}
@keyframes shake{10%,90%{transform:translateX(-2px)}20%,80%{transform:translateX(4px)}30%,50%,70%{transform:translateX(-6px)}40%,60%{transform:translateX(6px)}}
.hint{margin-top:6px;font-size:14px;color:var(--muted)}
.footerline{margin-top:8px;display:flex;align-items:center;justify-content:space-between}
.goalbar{display:flex;align-items:center;gap:12px;margin-bottom:12px}
.potion{height:16px;background:#e7ebff;border-radius:999px;overflow:hidden;flex:1;position:relative}
.potion i{display:block;height:100%;width:0;background:linear-gradient(90deg,#6aa9ff,#8bc34a);box-shadow:0 0 18px 6px rgba(138,204,101,.25) inset}
.grid{display:grid;grid-template-columns:repeat(5,minmax(0,1fr));gap:8px}
.cell{background:#fff;border:2px solid #dfe7ff;border-radius:14px;padding:10px;text-align:center;font-weight:800;cursor:pointer;min-height:54px;display:flex;align-items:center;justify-content:center;transition:transform .08s}
.cell:active{transform:scale(.98)}
.cell.good{outline:3px solid var(--success)}
.cell.bad{outline:3px solid var(--danger)}
.surprise{display:flex;flex-direction:column;gap:10px;align-items:center}
.surGrid{display:grid;grid-template-columns:repeat(2,1fr);gap:12px}
.surOpt{font-size:48px;border-radius:16px;border:2px solid #e4e8ff;background:#fff;padding:8px 12px;cursor:pointer}

/* Histoires */
.storyList{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px}
.storyBox{margin-top:14px;background:#fff;border:2px solid #e4e8ff;border-radius:16px;padding:12px;display:none}
.typewriter{min-height:120px;white-space:pre-wrap}

/* Fin de niveau */
#finishDlg .stars{display:flex;gap:8px;justify-content:center;margin:8px 0}
.star{width:36px;height:36px;clip-path:polygon(50% 0%,61% 35%,98% 35%,68% 57%,79% 91%,50% 70%,21% 91%,32% 57%,2% 35%,39% 35%);background:#ffd166;filter:drop-shadow(0 6px 10px rgba(0,0,0,.15))}
.star.off{background:#e6e6e6}
.chest{position:relative;width:160px;height:120px;margin:10px auto}
.chest .box{position:absolute;bottom:0;left:0;right:0;height:80px;background:#d08b43;border:4px solid #9a5d20;border-bottom-left-radius:10px;border-bottom-right-radius:10px}
.chest .lid{position:absolute;top:0;left:0;right:0;height:60px;background:#c27a38;border:4px solid #9a5d20;border-top-left-radius:10px;border-top-right-radius:10px;transform-origin:left bottom}
.chest.open .lid{animation:openLid .7s ease forwards}
@keyframes openLid{to{transform:rotateX(55deg)}}
.chest .shine{position:absolute;top:34px;left:10px;right:10px;height:18px;background:radial-gradient(circle,#fff8,transparent);opacity:0}
.chest.open .shine{animation:shine .9s ease .5s forwards}
@keyframes shine{to{opacity:1}}
.confetti{position:fixed;inset:0;pointer-events:none}

/* Grilles */
.cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(260px,1fr));gap:14px;margin:10px 0}

@media (max-width:920px){
  .row{grid-template-columns:1fr}
  .levels{grid-template-columns:repeat(3,minmax(0,1fr))}
  .grid{grid-template-columns:repeat(3,minmax(0,1fr))}
}
</style>
</head>
<body>
<canvas id="bgParticles"></canvas>

<!-- HEADER -->
<header class="header">
  <div class="wrap">
    <div class="brand"><span class="logo">ğŸª„</span> <span>Monde Magique</span></div>
    <nav class="nav">
      <button class="link" data-nav="home">Accueil</button>
      <button class="link" data-nav="games">Jeux</button>
      <button class="link" data-nav="stories">Histoires</button>
    </nav>
    <div class="stats">
      <span>â­ Bons: <b id="ok">0</b></span>
      <span>âŒ Erreurs: <b id="ko">0</b></span>
      <span>ğŸ•’ Temps: <b id="time">0s</b></span>
      <span>ğŸª™ PiÃ¨ces: <b id="coins">0</b></span>
    </div>
  </div>
</header>

<main class="container">
  <!-- ACCUEIL -->
  <section id="home" class="screen show fadein">
    <h2 class="headline gradient">Choisis une catÃ©gorie</h2>
    <div class="cards">
      <button class="btn gem cardPulse" data-nav="games">
        <span class="big">ğŸ®</span><h3>Jeux</h3><p>Apprends en tâ€™amusant.</p>
      </button>
      <button class="btn gem cardPulse" data-nav="stories">
        <span class="big">ğŸ“š</span><h3>Histoires</h3><p>3â€“5 min avec quiz.</p>
      </button>
    </div>
  </section>

  <!-- JEUX -->
  <section id="games" class="screen fadein">
    <h2 class="headline gradient">Jeux</h2>
    <div class="gamesGrid">
      <button class="btn gem" data-game="attrape"><span class="emoji">ğŸ¯</span>
        <div><h3>Attrape le mot</h3><p>2 images + 2 mots</p></div>
      </button>
      <button class="btn gem" data-game="shaman"><span class="emoji">ğŸª„</span>
        <div><h3>Shaman Magic</h3><p>Choisis par genre</p></div>
      </button>
      <button class="btn gem" data-game="surprise"><span class="emoji">ğŸ</span>
        <div><h3>Jeu surprise</h3><p>DÃ©couvre la magie</p></div>
      </button>
    </div>
  </section>

  <!-- ZONE DE JEU -->
  <section id="play" class="screen fadein">
    <div class="toolbar">
      <button class="btn soft" id="backLevels">â¬…ï¸ Niveaux</button>
      <span class="badge" id="gameTitle"></span>
      <span class="badge" id="levelTitle"></span>
    </div>

    <!-- ATTRAPE -->
    <div id="mode-attrape" class="mode">
      <div class="row">
        <div class="images">
          <div class="imgcard float" id="imgA"><span>ğŸª¸</span><p>â€”</p></div>
          <div class="imgcard float" id="imgB"><span>ğŸ¸</span><p>â€”</p></div>
        </div>
        <div class="choices">
          <button class="btn pill neon choice" id="opt1">mot 1</button>
          <button class="btn pill neon choice" id="opt2">mot 2</button>
          <div class="hint" id="hintAttrape"></div>
        </div>
      </div>
      <div class="footerline">
        <span id="seriesTxt">SÃ©rie 1 / 1</span>
        <button class="btn success" id="btnFinishAttrape">Terminer le niveau âœ…</button>
      </div>
    </div>

    <!-- SHAMAN -->
    <div id="mode-shaman" class="mode">
      <div class="goalbar">
        <span id="goalText">SÃ©lectionne uniquement les mots masculins</span>
        <div class="potion"><i id="bar"></i></div>
      </div>
      <div class="grid" id="grid"></div>
      <div class="footerline">
        <button class="btn success" id="btnFinishShaman">Terminer le niveau âœ…</button>
      </div>
      <div class="hint" id="hintShaman"></div>
    </div>

    <!-- SURPRISE -->
    <div id="mode-surprise" class="mode">
      <h3 class="headline gradient">ğŸ Devine par le son</h3>
      <p>Ã‰coute lâ€™indice puis choisis.</p>
      <div class="surprise">
        <button class="btn soft" id="btnPlayClue">ğŸ”Š Jouer lâ€™indice</button>
        <div class="surGrid">
          <button class="surOpt" id="sur1">ğŸœ</button>
          <button class="surOpt" id="sur2">ğŸ¸</button>
        </div>
        <div class="hint" id="hintSur"></div>
        <div class="footerline">
          <button class="btn success" id="btnFinishSur">Terminer le niveau âœ…</button>
        </div>
      </div>
    </div>
  </section>

  <!-- HISTOIRES -->
  <section id="stories" class="screen fadein">
    <h2 class="headline gradient">Histoires magiques</h2>
    <div class="storyList" id="storyList"></div>
    <article class="storyBox" id="storyBox">
      <h3 id="storyTitle">â€”</h3>
      <div id="storyText" class="typewriter"></div>
      <div class="cards" id="quizBox" style="display:none"></div>
      <div class="cards">
        <button class="btn soft" id="btnStoryPlay">ğŸ”Š Ã‰couter</button>
        <button class="btn primary" id="btnStoryNew">ğŸ”„ Nouvelle version</button>
      </div>
    </article>
  </section>
</main>

<!-- FOOTER -->
<footer class="footer">
  <div class="wrap">
    <div class="motto">Continue dâ€™apprendre, petit magicien ! ğŸª„</div>
    <div class="icons">â­ â¤ï¸ ğŸ“š ğŸ¯ ğŸ§ </div>
  </div>
</footer>

<!-- Dialog Niveaux (sous-menu par jeu) -->
<dialog id="dlgLevels">
  <h3 id="dlgTitle">Niveaux</h3>
  <div class="levels" id="dlgLevelsGrid"></div>
  <div class="cards" style="margin-top:10px;justify-content:flex-end">
    <button class="btn soft" id="dlgClose">Fermer</button>
  </div>
</dialog>

<!-- Dialog Fin de niveau -->
<dialog id="finishDlg">
  <h3 class="headline gradient">ğŸ‰ Niveau terminÃ© !</h3>
  <div class="stars" id="stars"></div>
  <div class="chest" id="chest"><div class="lid"></div><div class="box"></div><div class="shine"></div></div>
  <p id="finishMsg">Tu gagnes des piÃ¨ces !</p>
  <div class="cards" style="justify-content:flex-end">
    <button class="btn primary" id="btnGoLevels">Retour aux niveaux</button>
  </div>
</dialog>

<canvas id="confetti" class="confetti"></canvas>

<script>
/* ====== DonnÃ©es ====== */
const WORDS=[
 {w:"grenouille",g:"f",e:"ğŸ¸",rule:"-ouille â†’ fÃ©minin"},
 {w:"corail",g:"m",e:"ğŸª¸",rule:"-ail â†’ masculin"},
 {w:"Ã©ventail",g:"m",e:"ğŸª­",rule:"-ail â†’ masculin"},
 {w:"muraille",g:"f",e:"ğŸ§±",rule:"-aille â†’ fÃ©minin"},
 {w:"paille",g:"f",e:"ğŸ¥¤",rule:"-aille â†’ fÃ©minin"},
 {w:"nouille",g:"f",e:"ğŸœ",rule:"-ouille â†’ fÃ©minin"},
 {w:"portail",g:"m",e:"ğŸšª",rule:"-ail â†’ masculin"},
 {w:"citrouille",g:"f",e:"ğŸƒ",rule:"-ouille â†’ fÃ©minin"},
 {w:"bataille",g:"f",e:"âš”ï¸",rule:"-aille â†’ fÃ©minin"},
 {w:"ratatouille",g:"f",e:"ğŸ¥˜",rule:"-ouille â†’ fÃ©minin"},
 {w:"Ã©caille",g:"f",e:"ğŸŸ",rule:"-aille â†’ fÃ©minin"},
 {w:"Ã©pouvantail",g:"m",e:"ğŸŒ¾",rule:"-ail â†’ masculin"},
 {w:"fenouil",g:"m",e:"ğŸ¥¬",rule:"-ouil â†’ masculin (souvent)"},
 {w:"rail",g:"m",e:"ğŸ›¤ï¸",rule:"-ail â†’ masculin"},
 {w:"travail",g:"m",e:"ğŸ’¼",rule:"-ail â†’ masculin"},
 {w:"mÃ©daille",g:"f",e:"ğŸ¥‡",rule:"-aille â†’ fÃ©minin"},
];

/* ====== Ã‰tat / utilitaires ====== */
const STORE={coins:'lena.coins',progress:'lena.progress.onefile.fr'};
let coins=+(localStorage.getItem(STORE.coins)||0);
let ok=0,ko=0,timerInt=null,startedAt=Date.now();
const $=id=>document.getElementById(id);
const views={home:$('home'),games:$('games'),play:$('play'),stories:$('stories')};
const stats={ok:$('ok'),ko:$('ko'),time:$('time'),coins:$('coins')};
stats.coins.innerText=coins;

function updateStats(){ stats.ok.innerText=ok; stats.ko.innerText=ko; stats.coins.innerText=coins; }
function addCoins(n){ coins+=n; localStorage.setItem(STORE.coins,coins); updateStats(); }
function startTimer(){ if(timerInt) clearInterval(timerInt); startedAt=Date.now(); timerInt=setInterval(()=>{ stats.time.innerText=Math.floor((Date.now()-startedAt)/1000)+'s'; },250); }
function shuffle(a){ return a.map(v=>[Math.random(),v]).sort((x,y)=>x[0]-y[0]).map(x=>x[1]); }
function speak(t){ try{ const u=new SpeechSynthesisUtterance(t); u.lang='fr-FR'; u.rate=.95; speechSynthesis.cancel(); speechSynthesis.speak(u);}catch(e){} }
function articleOf(w){ const v=/^[aeiouyÃ¢ÃªÃ®Ã´Ã»Ã©Ã¨Ã«Ã¯Ã¼Å“]/i.test(w.w); return (w.g==='m'?(v?"lâ€™":"le"):(v?"lâ€™":"la")); }
function loadProgress(){ try{ return JSON.parse(localStorage.getItem(STORE.progress)||'{}'); }catch(_){ return {}; } }
function saveProgress(game,level){ const p=loadProgress(); p[game]=p[game]||{}; p[game][level]=true; localStorage.setItem(STORE.progress,JSON.stringify(p)); }
function show(view){ Object.values(views).forEach(v=>v.classList.remove('show')); views[view].classList.add('show'); startTimer(); }

document.querySelectorAll('[data-nav]').forEach(b=>b.addEventListener('click',()=>show(b.dataset.nav)));

/* ====== Fond de particules ====== */
const bg=document.getElementById('bgParticles'); const g=bg.getContext('2d');
function resizeBg(){ bg.width=innerWidth; bg.height=innerHeight; } addEventListener('resize',resizeBg); resizeBg();
const P=Array.from({length:90},()=>({x:Math.random()*bg.width,y:Math.random()*bg.height,vx:(Math.random()-.5)*.6,vy:(Math.random()-.5)*.6,r:1+Math.random()*2,a:.3+.5*Math.random()}));
(function loop(){ g.clearRect(0,0,bg.width,bg.height); P.forEach(p=>{ p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>bg.width)p.vx*=-1;if(p.y<0||p.y>bg.height)p.vy*=-1; g.globalAlpha=p.a; g.beginPath(); g.arc(p.x,p.y,p.r,0,Math.PI*2); g.fillStyle='#b39dfd'; g.fill(); }); requestAnimationFrame(loop); })();

/* ====== Dialog Niveaux ====== */
const dlg=$('dlgLevels'), dlgTitle=$('dlgTitle'), dlgGrid=$('dlgLevelsGrid');
$('dlgClose').onclick=()=>dlg.close();

/* ====== Lancement depuis JEUX ====== */
let currentGame='attrape', currentLevel=1;
document.querySelectorAll('[data-game]').forEach(b=>b.addEventListener('click',()=>{
  currentGame=b.dataset.game;
  openLevels(currentGame);
}));

function openLevels(game){
  dlgTitle.innerText = (game==='attrape'?'ğŸ¯ Attrape le mot â€” Niveaux': game==='shaman'?'ğŸª„ Shaman Magic â€” Niveaux':'ğŸ Surprise â€” Niveaux');
  const prog=loadProgress(); dlgGrid.innerHTML='';
  for(let i=1;i<=5;i++){
    const btn=document.createElement('button'); btn.className='levelbtn'; btn.textContent=`Niveau ${i}`;
    if(prog[game]?.[i]) btn.classList.add('done');
    btn.onclick=()=>{ currentLevel=i; startLevel(game,i); dlg.close(); };
    dlgGrid.appendChild(btn);
  }
  dlg.showModal();
}

$('backLevels').onclick=()=>openLevels(currentGame);

/* ====== Zone de jeu ====== */
function startLevel(game, lvl){
  ok=0; ko=0; updateStats();
  $('gameTitle').innerText=(game==='attrape'?'ğŸ¯ Attrape le mot':game==='shaman'?'ğŸª„ Shaman Magic':'ğŸ Surprise');
  $('levelTitle').innerText=`Niveau ${lvl}`;
  if(game==='attrape'){ setupAttrape(); showMode('attrape'); }
  else if(game==='shaman'){ setupShaman(); showMode('shaman'); }
  else { setupSurprise(); showMode('surprise'); }
  show('play');
}
function showMode(m){ ['attrape','shaman','surprise'].forEach(x=>document.getElementById('mode-'+x).style.display=(x===m?'block':'none')); }

/* ====== Confettis ====== */
function confettiBurst(){
  const c=$('confetti'); const ctx=c.getContext('2d'); c.width=innerWidth; c.height=innerHeight;
  const parts=Array.from({length:90},()=>({x:c.width/2,y:c.height/2,vx:(Math.random()-.5)*9,vy:(Math.random()-1.2)*8,a:1,r:2+Math.random()*3}));
  (function step(){ ctx.clearRect(0,0,c.width,c.height); parts.forEach(p=>{ p.x+=p.vx; p.y+=p.vy; p.vy+=.2; p.a-=.02; ctx.globalAlpha=Math.max(p.a,0); ctx.beginPath(); ctx.arc(p.x,p.y,p.r,0,Math.PI*2); ctx.fill(); }); if(parts.some(p=>p.a>0)) requestAnimationFrame(step); else ctx.clearRect(0,0,c.width,c.height); })();
}

/* ====== Jeu 1 : Attrape le mot (avancÃ©e auto) ====== */
let attrWords=[], attrIdx=0, attrCurrent=null;
function poolAttr(lvl){
  const groups=[['travail','corail','paille','grenouille'],['muraille','nouille','portail','citrouille'],['bataille','ratatouille','Ã©caille','rail'],['mÃ©daille','Ã©ventail','fenouil','Ã©pouvantail'],['corail','citrouille','grenouille','mÃ©daille']];
  const names=groups[Math.max(0,Math.min(4,lvl-1))]; return WORDS.filter(w=>names.includes(w.w));
}
function setupAttrape(){ attrWords=shuffle(poolAttr(currentLevel)); attrIdx=0; $('hintAttrape').innerText=''; $('seriesTxt').innerText='SÃ©rie 1 / 1'; renderAttrape(); }
function renderAttrape(){
  const a=attrWords[attrIdx], b=pickConfuser(a); attrCurrent={correct:a,other:b};
  $('imgA').querySelector('span').innerText=a.e; $('imgA').querySelector('p').innerText=a.w;
  $('imgB').querySelector('span').innerText=b.e; $('imgB').querySelector('p').innerText=b.w;
  const opts=shuffle([a.w,b.w]); $('opt1').innerText=opts[0]; $('opt2').innerText=opts[1];
  ['opt1','opt2'].forEach(id=>$(id).classList.remove('correct','wrong'));
}
function pickConfuser(word){ const end=word.w.slice(-4); const c=WORDS.filter(w=>w.w!==word.w&&(w.w.endsWith(end)||w.w.includes(end.slice(-3)))); return (c.length?c:WORDS.filter(w=>w.g!==word.g))[Math.floor(Math.random()*(c.length?c.length:WORDS.length))]; }
$('opt1').onclick=()=>chooseAttr($('opt1')); $('opt2').onclick=()=>chooseAttr($('opt2'));
function chooseAttr(btn){
  const text=btn.innerText, isRight=text===attrCurrent.correct.w;
  if(isRight){ ok++; addCoins(1); updateStats(); btn.classList.add('correct'); confettiBurst(); $('hintAttrape').innerText=`âœ… ${articleOf(attrCurrent.correct)} ${attrCurrent.correct.w} â€” ${attrCurrent.correct.rule}`; }
  else{ ko++; updateStats(); btn.classList.add('wrong'); navigator.vibrate?.([20,40,20]); $('hintAttrape').innerText=`âŒ Ce nâ€™est pas â€œ${text}â€. Correct: ${articleOf(attrCurrent.correct)} ${attrCurrent.correct.w}. Indice: ${attrCurrent.correct.rule}`; }
  // Avance auto vers la suivante
  setTimeout(()=>{ if(attrIdx<attrWords.length-1){ attrIdx++; renderAttrape(); } else { $('hintAttrape').innerText='ğŸ‰ SÃ©rie terminÃ©e. â€œTerminer le niveauâ€.'; } }, 650);
}
$('btnFinishAttrape').onclick=()=>finishLevel();

/* ====== Jeu 2 : Shaman Magic (avancÃ©e visuelle) ====== */
let target='m';
function setupShaman(){ target=(currentLevel%2===1)?'m':'f'; $('goalText').innerText=target==='m'?'SÃ©lectionne uniquement les mots masculins':'SÃ©lectionne uniquement les mots fÃ©minins'; $('bar').style.width='0%'; $('hintShaman').innerText=''; renderBoard(); }
function renderBoard(){
  const grid=$('grid'); grid.innerHTML=''; shuffle(WORDS).slice(0,15).forEach(w=>{
    const d=document.createElement('div'); d.className='cell'; d.textContent=w.w;
    d.onclick=()=>{ const okPick=(w.g===target); if(okPick){ d.classList.add('good'); ok++; addCoins(1); updateStats(); confettiBurst(); const good=document.querySelectorAll('.cell.good').length; $('bar').style.width=Math.min(100,good*10)+'%'; $('hintShaman').innerText=`âœ… ${articleOf(w)} ${w.w} â€” ${w.rule}`; }
      else{ d.classList.add('bad'); ko++; updateStats(); $('hintShaman').innerText=`âŒ ${w.w} nâ€™est pas du bon genre.`; navigator.vibrate?.([20,40,20]); } };
    grid.appendChild(d);
  });
}
$('btnFinishShaman').onclick=()=>finishLevel();

/* ====== Jeu 3 : Surprise ====== */
function setupSurprise(){ $('hintSur').innerText=''; }
$('btnPlayClue').onclick=()=>speak('nouille');
$('sur1').onclick=()=>{ ok++; addCoins(1); updateStats(); $('hintSur').innerText='âœ… Bravo ! Câ€™Ã©tait â€œnouilleâ€.'; confettiBurst(); setTimeout(()=>$('hintSur').innerText='âœ¨ Tu peux terminer le niveau.', 700); };
$('sur2').onclick=()=>{ ko++; updateStats(); $('hintSur').innerText='âŒ Oups ! Câ€™est â€œgrenouilleâ€.'; navigator.vibrate?.([20,40,20]); };

/* ====== Fin de niveau ====== */
$('btnGoLevels').onclick=()=>{ $('finishDlg').close(); openLevels(currentGame); };
function finishLevel(){
  saveProgress(currentGame,currentLevel);
  const accuracy=ok+ko>0? ok/(ok+ko) : 1;
  const stars = accuracy>=.9?3:accuracy>=.7?2:1;
  const cont=$('stars'); cont.innerHTML=''; for(let i=0;i<3;i++){ const s=document.createElement('div'); s.className='star'+(i<stars?'':' off'); cont.appendChild(s); }
  const chest=$('chest'); chest.classList.remove('open'); setTimeout(()=>chest.classList.add('open'), 200);
  const reward=stars*5; addCoins(reward);
  $('finishMsg').innerText=`Tu gagnes +${reward} ğŸª™ (prÃ©cision ${(accuracy*100|0)}%)`;
  $('finishDlg').showModal();
}

/* ====== Histoires + Quiz ====== */
const storyWords=WORDS.map(w=>w.w);
function buildStoryList(){
  const list=$('storyList'); list.innerHTML='';
  storyWords.forEach(k=>{ const b=document.createElement('button'); b.className='soft'; b.textContent=k+'  âœ'; b.onclick=()=>openStory(k); list.appendChild(b); });
}
function typewriter(el, text, speed=18){ el.innerText=''; let i=0; (function next(){ if(i<text.length){ el.innerText+=text[i++]; setTimeout(next, speed); } })(); }
function storyFor(word){
  const wObj=WORDS.find(x=>x.w===word)||{w:word,g:'m',e:'âœ¨'}; const art=articleOf(wObj);
  return `${wObj.e} Il Ã©tait une fois ${art}${word} qui rÃªvait dâ€™aventure.
Dans la forÃªt Ã©tincelante ğŸŒ²âœ¨, ${art}${word} rencontra une grenouille courageuse ğŸ¸ et une vieille muraille ğŸ§± qui savait parler.
â€œCherche la clÃ© du rire !â€, dit la muraille. Suspenseâ€¦ puis un cÅ“ur ğŸ’– apparut dans le ciel.
Ensemble, ils ont appris que la joie partagÃ©e illumine le chemin â­.`;
}
function quizFor(word){
  // 2â€“3 Q simples
  return [
    {q:"Quel est le hÃ©ros de lâ€™histoire ?", opts:[word,"un chat"], ok:0},
    {q:"Quel indice a donnÃ© la muraille ?", opts:["Cherche la clÃ© du rire","Cours trÃ¨s vite"], ok:0},
    {q:"Quâ€™apprennent-ils Ã  la fin ?", opts:["La joie partagÃ©e","La colÃ¨re gagne toujours"], ok:0},
  ];
}
function openStory(word){
  $('storyTitle').innerText='ğŸ“– '+word;
  $('storyBox').style.display='block';
  const txt=storyFor(word);
  typewriter($('storyText'), txt, 16);
  // mini quiz
  const quiz=quizFor(word); const box=$('quizBox'); box.innerHTML=''; box.style.display='grid';
  quiz.forEach((it,i)=>{
    const card=document.createElement('div'); card.className='soft'; card.style.padding='12px';
    const q=document.createElement('div'); q.style.fontWeight='900'; q.textContent='Q'+(i+1)+'. '+it.q; card.appendChild(q);
    const row=document.createElement('div'); row.style.display='flex'; row.style.gap='8px'; row.style.marginTop='6px';
    it.opts.forEach((o,idx)=>{
      const b=document.createElement('button'); b.className='btn soft'; b.textContent=o;
      b.onclick=()=>{
        const good=(idx===it.ok);
        if(good){ b.style.borderColor='#34c759'; b.style.background='#e9fbef'; addCoins(1); confettiBurst(); }
        else{ b.style.borderColor='#ff6b6b'; b.style.background='#ffecec'; navigator.vibrate?.([20,40,20]); }
        // dÃ©sactiver boutons de cette Q
        Array.from(row.children).forEach(ch=>ch.disabled=true);
      };
      row.appendChild(b);
    });
    card.appendChild(row); box.appendChild(card);
  });
}
$('btnStoryPlay').onclick=()=>speak($('storyText').innerText);
$('btnStoryNew').onclick=()=>{ const w=$('storyTitle').innerText.replace('ğŸ“– ',''); openStory(w); };

/* ====== Boot ====== */
function boot(){ show('home'); updateStats(); buildStoryList(); }
boot();
</script>
</body>
</html>
